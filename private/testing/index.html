<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>log into silly.chat</title>
    <link rel="stylesheet" href="index.css">
    <link rel="icon" href="favicon.png" type="image/x-icon">
</head>
<body>
    <div class="top"><span style="color: rgb(0, 0, 0);" >silly.chat</span></div>
    <div class="window">
        <form id="registerForm">
            <h1 style="color:rgb(0, 0, 0);">Send message</h1>
            <input type="text" id="message" placeholder="Message" required>
            <input type="text" id="myUserId" placeholder="Your user id" required>
            <input type="text" id="targetUserId" placeholder="target's user id" required>
            <button type="submit">Send message</button>
        </form>
        <form id="createChannel">
            <h1 style="color:rgb(0, 0, 0);">create channel</h1>
            <input type="text" id="u1" placeholder="Your user id" required>
            <input type="text" id="u2" placeholder="target's user id" required>
            <button type="submit">create channel</button>
        </form>

        <div class="messages-container">
            <h1 style="color:black;">Messages</h1>
            <div id="message-list" style="color:black;"></div> <!-- Here, messages will be displayed -->
        </div>
    </div>
    <script>
        document.getElementById('registerForm').addEventListener('submit', async function (e) {
            e.preventDefault()
            const message = document.getElementById('message').value.trim()
            const senderId = document.getElementById('myUserId').value.trim()
            const receiverId = document.getElementById('targetUserId').value.trim()

            if (!message || !senderId || !receiverId) {
                alert('missing fields')
                return
            }

            try {
                const res = await fetch('/sendMessage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message, senderId, receiverId })
                })

                const text = await res.text()

                if (res.ok) {
                    alert('success: ' + text)
                } else {
                    alert('error: ' + text)
                }
            } catch (err) {
                console.error(err)
                alert('could not connect to server')
            }
        })
    </script>

<script>
    document.getElementById('createChannel').addEventListener('submit', async function (e) {
        e.preventDefault()
        const firstId = document.getElementById('u1').value.trim()
        const secondId = document.getElementById('u2').value.trim()

        if (!firstId || !secondId) {
            alert('missing fields')
            return
        }

        try {
            const res = await fetch('/create-ch', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ firstId, secondId })
            })

            const text = await res.text()

            if (res.ok) {
                alert('success: ' + text)
            } else {
                alert('error: ' + text)
            }
        } catch (err) {
            console.error(err)
            alert('could not connect to server')
        }
    })
</script>

    <script>
        // Get the messages from the server (this function is called on page load)
        async function fetchMessages(targetId) {
            try {
                const res = await fetch(`/messages/${targetId}`); // Send a GET request to the server

                if (!res.ok) {
                    throw new Error('Failed to fetch messages');
                }

                const messages = await res.json(); // Parse JSON response

                // Call a function to display messages
                displayMessages(messages);
            } catch (error) {
                console.error(error);
                alert('Error fetching messages');
            }
        }


        // Function to display messages in the message list
        function displayMessages(messages) {
            const messageList = document.getElementById('message-list');
            messageList.innerHTML = ''; // Clear previous messages

            // Loop through the messages and create HTML elements to display them
            messages.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message'); // Add a class for styling
                messageElement.innerHTML = `
                    <p><strong>${message.senderId} â†’ ${message.receiverId}</strong></p>
                    <p>${message.message}</p>
                `;
                messageList.appendChild(messageElement);
            });
        }

        // Call the fetchMessages function with the target user ID (you can set this dynamically)
        const targetUserId = 2; // Example target user ID (replace with actual value)
        fetchMessages(targetUserId);
    </script>
</body>
</html>

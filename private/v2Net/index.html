<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>silly.chat</title>
    <link rel="stylesheet" href="app.css">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
    <div class="app">
        <div class="topbar">
            <span style="font-size: 2.3vh; font-family: font1; color: rgb(219, 219, 219);">silly.chat</span>
            <input type="text" placeholder="listener id (default 2)" id="setlistener">
            <button onclick="updateListenerId()">set listener id</button>
            <button onclick="resetListenerId()">reset the listener id</button>
        </div>
        <div class="window">
            <div class="leftbar">
                <div class="smallMenu">
                    <div class="topSearch">
                        <input type="text" placeholder="Find or start a conversation" id="topSearchInput" style="display: none;">
                    </div>

                </div>
                <div class="directs">
                    <div class="content">
                        <div class="users"></div>
                        <div class="localUser">
                            
                        </div>
                    </div>
                </div>
            </div>
            <div class="currentChat">
                <div class="title">
                    <img src="assets/earth.png" alt="" srcset="">
                    <span id="chatTitle" style="padding-left: 0.7vw;">Global chat</span>
                </div>
                
                <div id="content" class="content">
                    <div id="msg" class="msg" style="display: none;">
                        <div class="profile" style="padding: 0 1.3vw; padding-left: 3vw;">
                            <img src="assets/default.png" style="height: 4vh; width: 4vh; border-radius: 50%; object-fit: cover; margin-top: 5px;">
                        </div>
                        <div class="msgMain" style="display: flex; flex-direction: column; justify-content: center;">
                            <span class="userName" style="font-weight: 500; font-size: 0.9rem;">anonymous</span>
                            <p class="ContentMsg" style="padding-top: 0.2vh; text-align: left; margin: 0; font-size: 0.95rem; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">hello bro</p>
                        </div>
                    </div>
                </div>
                <div class="userInput">
                    <div class="uInput">
                        <img src="assets/circle-plus.png" alt="" srcset="" style="height:40%; padding-right: 2vw;">
                        <input style="font-size: 2.4vh;" id="mainInput" type="text" class="userInputInput" placeholder="Message the world" autocomplete="off">
                        <button onclick="const text=txtbox.value; txtbox.value=''; sendMsg(text)" class="sendButton"><img src="assets/send.png" style="height: 3.4vh; max-height: 1.5rem;" ></button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>

    </script>
    
    <script>
        let DEFAULT_GLOBAL_CHATID=2
        const shownMessages = [];
        const maincontainer=document.getElementById('content')
        const chatTitle=document.getElementById('chatTitle')
        const button=document.getElementById('sendBt')
        const txtbox=document.getElementById('mainInput')
        const socket = io('http://localhost:3000/', { withCredentials: true });
        txtbox.addEventListener('keydown', async(e)=>{
            if (e.key==='Enter'){
                e.preventDefault()
                console.log('msg')
                //displayMessage(txtbox.value)
                const text=txtbox.value
                txtbox.value=''
                sendMsg(text)
            }
        })
        socket.on('connect', (data) => {
            console.log('websocket connected');
            fetchMessages(DEFAULT_GLOBAL_CHATID)
        });
        function sendMsg(text){
            txtbox.value=''
            sendMsg(txtbox.value)
        }
        function updateListenerId(){
            const input=document.getElementById('setlistener')
            DEFAULT_GLOBAL_CHATID=input.value
            chatTitle.textContent='Semi-private messaging channel'
            clearMessages()
            fetchMessages(DEFAULT_GLOBAL_CHATID)
        }
        function resetListenerId(){
            const input=document.getElementById('setlistener')
            chatTitle.textContent='Global Chat'
            DEFAULT_GLOBAL_CHATID=2
            clearMessages()
            fetchMessages(DEFAULT_GLOBAL_CHATID)
        }

        function clearMessages() {
            maincontainer.innerHTML = '';
            shownMessages.length = 0;
        }
        async function sendMsg(msg) {
            try{
                const res = await fetch('/sendMessage', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message:msg,
                            senderId:2,
                            receiverId:DEFAULT_GLOBAL_CHATID
                        })
                        })
                        const text = await res.text()
                }catch(err){
                    console.error(err)
                    alert('could not connect to server')
                }
        }
        async function fetchMessages(targetId) {
            try {
                const res = await fetch(`/messages/${targetId}`);

                if (!res.ok) {
                    throw new Error('Failed to fetch messages');
                }

                const messages = await res.json();
                messages.forEach(msg => {
                    displayMessage2(msg);
                });
            } catch (error) {
                console.error(error);
                alert('Error fetching messages');
            }
        }
        const template=document.getElementById('msg')
        function displayMessage(message){
            if (shownMessages.includes(message)) return;
            const clone=template.cloneNode(true)
            shownMessages.push(message)
            clone.style.display='flex'
            clone.querySelector('.ContentMsg').innerText=message
            maincontainer.appendChild(clone)
        }
        function displayMessage2(data){
            if (shownMessages.includes(data.msgId)) return;
            const clone=template.cloneNode(true)
            shownMessages.push(data.msgId)
            clone.style.display='flex'
            clone.querySelector('.ContentMsg').innerText=data.message
            clone.querySelector('.userName').innerText=data.username
            maincontainer.appendChild(clone)
        }
        socket.on('NewMessage', (newMsg) => {
            console.log('received logs',newMsg);
            //fetchMessages(2)
            if (newMsg===undefined) return
            displayMessage2(newMsg)
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>silly.chat</title>
    <link rel="stylesheet" href="app.css">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
    <div class="app">
        <div class="topbar">
            <span style="font-size: 2.3vh; font-family: font1; color: rgb(219, 219, 219);">silly.chat</span>
        </div>
        <div class="window">
            <div id="leftBar" class="leftbar">
                <div class="leftBarButtons" style="width: 100%; height: 2%; background-color: rgb(0, 0, 0);">
                    <button style="display: none; width: 100%; text-align: left; padding-left: 2vw; padding-top: 1.5vh; padding-bottom: 1.5vh; border-radius: 0.7rem;">Friends</button>
                </div>
                <span style="margin-left: 1.3rem;margin-bottom: 0.3vh;    color: rgb(175, 175, 175); font-weight: 900;">direct messages</span>
                <span style="margin-left: 1.3rem;margin-bottom: 1.3vh;    color: rgb(124, 124, 124); font-weight: 700; font-size: 0.9rem;">not private dms yet sorry :(</span>
                    <div class="directs" style="overflow-y: auto; width: 100%; height: 100%; background-color: rgb(0, 0, 0); ">
                        <div class="direct"  style="display: none;" id="defUserButton">
                            <button onclick="showCurrentChat()" style="width: 100%; background-color: rgb(0, 0, 0); border: none; padding-left: 1.3rem; border-radius: 0.6rem;">
                                <div class="content">
                                    <div class="msg">
                                        <div class="profile">
                                            <img class="pfp" src="assets/default.png" style="height: 4.5vh; width: 4.5vh; border-radius: 50%; object-fit: cover; margin-top: 1px;">
                                        </div>
                                        <div class="msgMain" style="padding-left: 1rem; display: flex; flex-direction: column; justify-content: center;">
                                            <span class="username" style="color: rgb(163, 163, 163); font-weight: 700; font-size: 0.9rem;">Global chat</span>
                                        </div>
                                    </div>
                                </div>
                            </button>

                        </div>
                        <div style="padding-left: 1.3rem; padding-bottom: 1rem;">
                            <input type="text" placeholder="listener id (default 2)" id="setlistener">
                            <button onclick="updateListenerId()">set listener id</button>
                            <button onclick="resetListenerId()">reset the listener id</button>
                        </div>

                    </div>
                <div class="directs">

                    <div class="content">
                        <div class="users">

                        </div>
                        <div class="localUser">
                            
                        </div>
                    </div>
                </div>
            </div>

            <div id="MainChat" class="containerC">    
                <div class="currentChat">
                    <div class="title">
                        <button id="HideChat" style="background-color: transparent;" onclick="hideCurrentChat()"><img src="assets/chevron-left.png" alt="" srcset=""></button>
                        <img src="assets/earth.png" alt="" srcset="">
                        <span id="chatTitle" style="padding-left: 0.7rem; font-size: 2vh;">Global chat</span>
                    </div>
                    
                    <div id="content" class="content">
                        <div id="msg" class="msg" style="display: none;">
                            <div class="profile" style="padding: 0 1rem; padding-left: 2.8rem;">
                                <img src="assets/default.png" style="height: 1.9rem; width: 1.9rem; border-radius: 50%; object-fit: cover; margin-top: 5px;">
                            </div>
                            <div class="msgMain" style="display: flex; flex-direction: column; justify-content: center;">
                                <span class="userName" style="font-weight: 500; font-size: 0.9rem;">anonymous</span>
                                <p class="ContentMsg" style="padding-top: 0.2vh; text-align: left; margin: 0; font-size: 0.95rem; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">hello bro</p>
                            </div>
                        </div>
                    </div>
                    <div class="userInput">
                        <div class="uInput">
                            <img src="assets/circle-plus.png" alt="" srcset="" style="height:40%; padding-right: 1.7rem;">
                            <input style="font-size: 2.4vh;" id="mainInput" type="text" class="userInputInput" placeholder="Message the world" autocomplete="off">
                            <button id="send" style="display: none;" onclick="const text=txtbox.value; txtbox.value=''; sendMsg(text)" class="sendButton"><img src="assets/send.png" style="height: 3.4vh; max-height: 1.5rem;" ></button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="rightbar">

            </div>

        </div>
    </div>

    <script>
        const isMobile = /Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
        const sendButton=document.getElementById('send')
        const hideButton=document.getElementById('HideChat')
        if (isMobile) {
            sendButton.style="display:block;"
        } else {
            sendButton.style="display:none;"
            hideButton.style="display:none;"
        }

        function isMobilee(){
            if (isMobile) {
                return true
            } else {
                return false
            }
        }
        function hideCurrentChat(){
            if (!isMobilee()){return}
            document.getElementById('MainChat').style='display:none;'
            document.getElementById('leftBar').style='display:flex;'
        }
        function showCurrentChat(){
            if (!isMobilee()){return}
            document.getElementById('MainChat').style='display:block;'
            document.getElementById('leftBar').style='display:none;'
        }
        function isScrolledToBottom(container) {
            return container.scrollHeight - container.scrollTop <= container.clientHeight + 20; // 20px threshold
        }

        function scrollToBottom(container) {
            container.scrollTop = container.scrollHeight;
        }
    </script>
    <script>
        async function loadUsers() {
            const res = await fetch('/getAllUsers')
            const users = await res.json()
            const container = document.querySelector('.directs')
            const template = document.getElementById('defUserButton')

            users.accounts.forEach(user => {
                const clone = template.cloneNode(true)
                clone.style='display:block;'
                clone.querySelector('.username').textContent = user.username
                clone.querySelector('.pfp').src = user.pfp
                clone.onclick = () => {
                    DEFAULT_GLOBAL_CHATID = user.id
                    chatTitle.textContent=user.username
                    clearMessages()
                    fetchMessages(user.id)
                }
                container.appendChild(clone)
            })
        }
        loadUsers()
    </script>
    
    <script>
            let DEFAULT_GLOBAL_CHATID=2
            const shownMessages = [];
            const maincontainer=document.getElementById('content')
            const chatTitle=document.getElementById('chatTitle')
            const button=document.getElementById('sendBt')
            const txtbox=document.getElementById('mainInput')
            const socket = io('http://localhost:3000/', { withCredentials: true });
            txtbox.addEventListener('keydown', async(e)=>{
                if (e.key==='Enter'){
                    e.preventDefault()
                    console.log('msg')
                    //displayMessage(txtbox.value)
                    const text=txtbox.value
                    txtbox.value=''
                    sendMsg(text)
                }
            })
            socket.on('connect', (data) => {
                console.log('websocket connected');
                fetchMessages(DEFAULT_GLOBAL_CHATID)
            });
            function sendMsg(text){
                txtbox.value=''
                sendMsg(txtbox.value)
            }
            function updateListenerId(){
                const input=document.getElementById('setlistener')
                DEFAULT_GLOBAL_CHATID=input.value
                chatTitle.textContent='Semi-private messaging channel'
                clearMessages()
                fetchMessages(DEFAULT_GLOBAL_CHATID)
            }
            function resetListenerId(){
                const input=document.getElementById('setlistener')
                chatTitle.textContent='Global Chat'
                DEFAULT_GLOBAL_CHATID=2
                clearMessages()
                fetchMessages(DEFAULT_GLOBAL_CHATID)
            }

            function clearMessages() {
                maincontainer.innerHTML = '';
                shownMessages.length = 0;
            }
            async function sendMsg(msg) {
                try{
                    const res = await fetch('/sendMessage', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                message:msg,
                                senderId:2,
                                receiverId:DEFAULT_GLOBAL_CHATID
                            })
                            })
                            const text = await res.text()
                    }catch(err){
                        console.error(err)
                        alert('could not connect to server')
                    }
            }
            async function fetchMessages(targetId) {
                try {
                    const res = await fetch(`/messages/${targetId}`);

                    if (!res.ok) {
                        throw new Error('Failed to fetch messages');
                    }

                    const messages = await res.json();
                    messages.forEach(msg => {
                        displayMessage2(msg);
                    });
                } catch (error) {
                    console.error(error);
                    alert('Error fetching messages');
                }
            }
            const template=document.getElementById('msg')
            function displayMessage(message){
                if (shownMessages.includes(message)) return;
                const clone=template.cloneNode(true)
                shownMessages.push(message)
                clone.style='display:flex;'
                clone.querySelector('.ContentMsg').innerText=message
                maincontainer.appendChild(clone)
            }
            function displayMessage2(data){
                const shouldScroll = isScrolledToBottom(maincontainer);
                if (shownMessages.includes(data.msgId)) return;
                const clone=template.cloneNode(true)
                console.log(clone)
                shownMessages.push(data.msgId)
                clone.style='display:flex;'
                console.log(data.username)
                console.log(data.message)
                clone.querySelector('.ContentMsg').innerText=data.message
                clone.querySelector('.userName').innerText=data.username
                maincontainer.appendChild(clone)
                if (shouldScroll) {
                    scrollToBottom(maincontainer);
                }
            }
            socket.on('NewMessage', (newMsg) => {
                console.log('received logs',newMsg);
                //fetchMessages(2)
                if (newMsg===undefined) return
                displayMessage2(newMsg)
            });

    </script>
</body>
</html>